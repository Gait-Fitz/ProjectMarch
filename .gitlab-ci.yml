variables:
  GIT_SUBMODULE_STRATEGY: recursive

stages:
  - Tag container
  - Build container
  - Lint code
  - Build code
  - Test code
  - Static analysis on code

image: registry.gitlab.com/project-march/march:$CI_COMMIT_BRANCH

# Allow each branch to run their own container. This allows a branch to add
# dependencies to their package.xml and use them as expected. This process works as
# follows:
# 1. If an image with the tag of the current branch is not available, the base image
#   is pulled and tagged as the image for this branch.
# 2. If there are changes to the Dockerfile or to a package.xml file, rebuild the
#   container. This will use remote caches from GitLab to speed up the process.
container:tag:
  stage: Tag container
  image: quay.io/podman/stable
  variables:
    GIT_CHECKOUT: "true"
  before_script:
    - podman login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - if ! podman manifest inspect $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH; then podman pull $CI_REGISTRY_IMAGE:$CI_DEFAULT_BRANCH && podman tag $CI_REGISTRY_IMAGE:$CI_DEFAULT_BRANCH $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH && podman push $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH; fi;

container:build:
  stage: Build container
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - mkdir -p /kaniko/.docker
    # Equivalent to `docker login` but without installing docker"
    - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" > /kaniko/.docker/config.json
    # The kaniko executor from https://github.com/GoogleContainerTools/kaniko
    # Information about all the parameters can be found there.
    - /kaniko/executor --cache=true --dockerfile $CI_PROJECT_DIR/Dockerfile --destination $CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH --cleanup
  rules:
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - Dockerfile

.branch-base:
  only:
    refs:
      - branches

# Use this as a "base" for all jobs. Merge requests require a different variable
# for the Docker image tag.
.merge_request-base:
  image: registry.gitlab.com/project-march/march:$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
  only:
    refs:
      - merge_requests

# Runs a linter on the code to see if the code style is consistent and to avoid common
# mistakes
.flake8-base:
  stage: Lint code
  dependencies: ["container:tag"]
  script:
    - python3 -m flakehell lint --suppress-none-returning --format=gitlab --output-file flakehell.json
  artifacts:
    reports:
      codequality: flakehell.json
  allow_failure: true
  only:
    changes:
      - "pyproject.toml"
      - "**/*.py"

flake8:
  extends:
    - .flake8-base
    - .branch-base

flake8 for MRs:
  extends:
    - .flake8-base
    - .merge_request-base

.clang_format-base:
  stage: Lint code
  script:
    - python3 .scripts/run-clang-format.py -r ros1/src ros2/src --style=file
  only:
    changes:
      - "ros1/**/*.{c,h,C,H,cpp,hpp,cc,hh,c++,h++,cxx,hxx}"
      - "ros2/**/*.{c,h,C,H,cpp,hpp,cc,hh,c++,h++,cxx,hxx}"

clang_format:
  extends:
    - .clang_format-base
    - .branch-base

clang_format for MRs:
  extends:
    - .clang_format-base
    - .merge_request-base

.noetic:build-base:
  stage: Build code
  artifacts:
    paths:
      - ros1/build/
      - ros1/install/
      - ros1/log/
  script:
    - cd ros1/
    - source /opt/ros/noetic/local_setup.bash && colcon build --cmake-args "-DCMAKE_EXPORT_COMPILE_COMMANDS=1" --event-handlers console_direct+
  only:
    changes:
      - "ros1/**"
      - ".clang-tidy"

noetic:build:
  extends:
    - .noetic:build-base
    - .branch-base

noetic:build for MRs:
  extends:
    - .noetic:build-base
    - .merge_request-base

.foxy:build-base:
  stage: Build code
  artifacts:
    paths:
      - ros2/build/
      - ros2/install/
      - ros2/log/
  script:
    - cd ros2/
    - source /opt/ros/foxy/local_setup.bash && colcon build --cmake-args "-DCMAKE_EXPORT_COMPILE_COMMANDS=1" --event-handlers console_direct+
  only:
    changes:
      - "ros2/**"
      - ".clang-tidy"

foxy:build:
  extends:
    - .foxy:build-base
    - .branch-base

foxy:build for MRs:
  extends:
    - .foxy:build-base
    - .merge_request-base

.noetic:test-base:
  stage: Test code
  dependencies:
    - noetic:build
  needs: ["noetic:build"]
  script:
    - cd ros1/
    - source /opt/ros/noetic/local_setup.bash && source install/local_setup.bash && colcon test --event-handlers console_direct+
    - colcon test-result --verbose
  only:
    changes:
      - "ros1/**"

noetic:test:
  extends:
    - .noetic:test-base
    - .branch-base

noetic:test for MRs:
  dependencies: ["noetic:build for MRs"]
  needs: ["noetic:build for MRs"]
  extends:
    - .noetic:test-base
    - .merge_request-base

.foxy:test-base:
  stage: Test code
  dependencies:
    - foxy:build
  needs: ["foxy:build"]
  script:
    - cd ros2/
    - source /opt/ros/foxy/local_setup.bash && source install/local_setup.bash && colcon test --event-handlers console_direct+
    - colcon test-result --verbose
  only:
    changes:
      - "ros2/**"

foxy:test:
  extends:
    - .foxy:test-base
    - .branch-base

foxy:test for MRs:
  dependencies: ["foxy:build for MRs"]
  needs: ["foxy:build for MRs"]
  extends:
    - .foxy:test-base
    - .merge_request-base

.noetic:clang_tidy-base:
  stage: Static analysis on code
  dependencies:
    - noetic:build
  needs: ["noetic:build"]
  script:
    - cd ros1/
    - find src -name '*.hpp' -or -name '*.h' -or -name '*.cpp' | grep -v "src/libraries" | grep -v "xsens" | xargs -L1 -P$(getconf _NPROCESSORS_ONLN) -I{} -- clang-tidy -p build {} 2> /dev/null
  only:
    changes:
      - "ros1/**/*.{hpp,h,cpp}"
      - "ros1/**/CMakeLists.txt"
      - ".clang-tidy"

noetic:clang_tidy:
  extends:
    - .noetic:clang_tidy-base
    - .branch-base

noetic:clang_tidy for MRs:
  dependencies: ["noetic:build for MRs"]
  needs: ["noetic:build for MRs"]
  extends:
    - .noetic:clang_tidy-base
    - .merge_request-base

.foxy:clang_tidy-base:
  stage: Static analysis on code
  dependencies:
    - foxy:build
  needs: ["foxy:build"]
  script:
    - cd ros2/
    - find src -name '*.hpp' -or -name '*.h' -or -name '*.cpp' | grep -v "src/libraries" | xargs -L1 -P$(getconf _NPROCESSORS_ONLN) -I{} -- clang-tidy -p build {} 2> /dev/null
  only:
    changes:
      - "ros2/**/*.{hpp,h,cpp}"
      - "ros2/**/CMakeLists.txt"
      - ".clang-tidy"

foxy:clang_tidy:
  extends:
    - .foxy:clang_tidy-base
    - .branch-base

foxy:clang_tidy for MRs:
  dependencies: ["foxy:build for MRs"]
  needs: ["foxy:build for MRs"]
  extends:
    - .foxy:clang_tidy-base
    - .merge_request-base
