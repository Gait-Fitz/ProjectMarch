###############
# Sphinx build #
###############
# Build the documentation and checks it for warnings and errors.
Sphinx build:
  stage: Build documentation
  # The "$TAG" variable is set by the rules below
  image: $CI_REGISTRY_IMAGE/sphinx:$TAG
  before_script:
    - cd docs
  script:
    - sphinx-build -W -b html . build
  variables:
    DOCKER_FILE: ".gitlab/dockerfiles/sphinx"
  artifacts:
    paths:
      - docs/build/
  needs:
    - job: "sphinx container build"
      optional: true
  rules:
    # The first three rules are only relevant when the Dockerfile has changed, because
    # it defines the correct TAG
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - $DOCKER_FILE
      variables:
        TAG: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME
    - if: '$CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS'
      when: never
    - if: '$CI_COMMIT_BRANCH'
      changes:
        - $DOCKER_FILE
      variables:
        TAG: $CI_COMMIT_BRANCH
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH'
      variables:
        TAG: $CI_DEFAULT_BRANCH

################
# HTML proofer #
################
Sphinx HTML proofer:
  stage: Test documentation
  # The "$TAG" variable is set by the rules below
  image: klakegg/html-proofer
  needs:
    - job: "Sphinx build"
      artifacts: true
  before_script:
    - cd docs
  script:
    - htmlproofer ./build --only-4xx --check-html --file-ignore ./build/html/genindex.html,./build/html/search.html,./build/html/index-msg.html --alt-ignore '/.*/' --url-ignore '#'

#########
# Pages #
#########
Publish Sphinx on GitLab Pages:
  stage: Publish documentation
  image: klakegg/html-proofer
  needs:
    - job: "Sphinx build"
      artifacts: true
    - job: "Sphinx HTML proofer"
  before_script:
    - cd docs
  script:
    - echo 'Publishing pages...'
    - cp -R build/html/ public/
  artifacts:
    paths:
      - public
