# See https://hub.docker.com/_/ros
FROM ros:noetic

# Because we build this image in a non-interactive environment, we should notify Debian that
# we cannot respond to required interaction. This will assume the default values in case
# an interactive window pops up.
ARG DEBIAN_FRONTEND=noninteractive

# Build tools
RUN apt update && apt install -y    python3-pip \       # We need pip to install certain python dependencies
                                    clang \             # clang is used to compile C++ code
                                    clang-tidy \        # clang-tidy is used in a different pipeline stage
                                    git \               # We need git and git-lfs to get repo information from
                                    git-lfs             # inside the container.

# Non-ROS Python dependencies
COPY requirements.pip /march/requirements.pip
RUN bash -c "python3 -m pip install mock argcomplete pytest-repeat pytest-rerunfailures pytest $(cat /march/requirements.pip | sort | tr '\n' ' ')"

# Copy the project into the container to automatically detect all dependencies.
COPY ros1/src /march/src

# Install all ROS1 packages
# This runs the `rosdep` program, which automatically finds dependencies declared in package.xml files
# and installs them. See https://docs.ros.org/en/independent/api/rosdep/html/commands.html for
# command line reference.
RUN apt update && rosdep update --rosdistro noetic && rosdep install --rosdistro noetic -y --from-paths /march/src --ignore-src

# Remove march files to save space
RUN rm -rf /march
